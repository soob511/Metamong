<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mycompany.metamong.daoMain.MemberDao">
	<select id="selectByMId" parameterType="String"
		resultType="Member">
		SELECT
		m_id, m_name, m_password, team_id, m_empid, m_tel,
		m_role, m_isactive,
		prof_filename,
		prof_filetype, prof_filedata,
		m_applydate, m_isapprove, m_regdate
		FROM
		member
		WHERE
		m_id = #{mId} AND
		m_isactive = 1
	</select>

	<insert id="insertJoin" parameterType="Member">
    INSERT INTO member (
        m_id,
        m_name,
        m_password,
        team_id,
        m_empid,
        m_tel,
        m_role,
        m_isactive,
        m_applydate,
        m_ISAPPROVE
    ) VALUES (
        #{MId},
        #{MName},
        #{MPassword},
        #{teamId},
        #{MEmpId},
        #{MTel},
        #{MRole},
        1,
        sysdate,
        0
    )
	</insert>

	<select id="selectMId" parameterType="String" resultType="int">
		SELECT count(*)
		FROM member
		WHERE M_Id = #{MId}
	</select>

	<select id="countRows" resultType="int">
		SELECT count(*)
		FROM member
	    WHERE 
           m_role != 'ROLE_ADMIN'
	</select>

	<select id="selectMemberList" parameterType="Pager" resultType="Member">
	    <![CDATA[
	        SELECT
	            rnum, m_id, m_name, REPLACE(m_role, 'ROLE_', '') AS m_role, team_id, team_name, m_empid, m_tel
	        FROM (
	            SELECT 
	                rownum AS rnum, m.m_id, m.m_name, REPLACE(m.m_role, 'ROLE_', '') AS m_role, m.team_id, t.team_name, m.m_empid, m.m_tel
	            FROM 
	                member m
	            LEFT OUTER JOIN 
	                team t ON m.team_id = t.team_id
	            WHERE 
	                m.m_role != 'ROLE_ADMIN'
	            ORDER BY 
	                m.m_name, m.m_id
	        )
	        WHERE rnum BETWEEN #{startRowNo} AND #{endRowNo}
	    ]]>
	</select>
	
	<select id="selectMemberSearch" parameterType="Pager" resultType="Member">
		SELECT 
		    m.M_id AS MId, 
		    m.M_name AS MName, 
		    REPLACE(m.M_role, 'ROLE_', '') AS MRole, 
		    t.team_id AS teamId, 
		    t.team_name AS teamName, 
		    m.M_empid AS MEmpId, 
		    m.M_tel AS MTel
		FROM member m
		FULL OUTER JOIN team t ON m.team_id = t.team_id
		<where>
			<if test="keyword != null and keyword != '' and option == 'ID'">
            LOWER(m.M_id) LIKE CONCAT(CONCAT('%', LOWER(#{keyword})), '%')
        	</if>
			<if test="keyword != null and keyword != '' and option == '이름'">
				m.M_name LIKE CONCAT(CONCAT('%', #{keyword}), '%')
			</if>
			<if test="keyword != null and keyword != '' and option == '권한'">
            LOWER(m.M_role) LIKE CONCAT(CONCAT('%', LOWER(#{keyword})), '%')
        	</if>
			<if test="keyword != null and keyword != '' and option == '소속'">
				t.team_name LIKE CONCAT(CONCAT('%', #{keyword}), '%')
			</if>
			<if test="keyword != null and keyword != '' and option == '사번'">
            LOWER(m.M_empid) LIKE CONCAT(CONCAT('%', LOWER(#{keyword})), '%')
        	</if>
			
		</where>
		  
	</select>
	
	<select id="countMembers" parameterType="map" resultType="int">
	    SELECT COUNT(*) 
	    FROM member m
	    FULL OUTER JOIN team t ON m.team_id = t.team_id
	   <where>
			<if test="keyword != null and keyword != '' and option == 'ID'">
            LOWER(m.M_id) LIKE CONCAT(CONCAT('%', LOWER(#{keyword})), '%')
        	</if>
			<if test="keyword != null and keyword != '' and option == '이름'">
				m.M_name LIKE CONCAT(CONCAT('%', #{keyword}), '%')
			</if>
			<if test="keyword != null and keyword != '' and option == '권한'">
            LOWER(m.M_role) LIKE CONCAT(CONCAT('%', LOWER(#{keyword})), '%')
        	</if>
			<if test="keyword != null and keyword != '' and option == '소속'">
				t.team_name LIKE CONCAT(CONCAT('%', #{keyword}), '%')
			</if>
			<if test="keyword != null and keyword != '' and option == '사번'">
            LOWER(m.M_empid) LIKE CONCAT(CONCAT('%', LOWER(#{keyword})), '%')
        	</if>
			
		</where>
		  
	</select>

</mapper>
	